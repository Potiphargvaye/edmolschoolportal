@extends('layouts.admin')

@section('content')
<div class="container mx-auto px-4 py-8">
    <!-- Banner Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 mb-6 rounded-xl shadow-sm">
        <h1 class="text-2xl sm:text-3xl font-bold">Fees Management System</h1>
        <p class="text-indigo-100 mt-2">Manage student fees and payments</p>
    </div>

    <div class="admin-container">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <h2 class="text-xl font-bold text-gray-800">Fees Management</h2>
            <button onclick="openModal('assignFeeModal')" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg">
                <i class="fas fa-plus"></i>
                Assign New Fee
            </button>
        </div>

        <!-- Academic Year Filter -->
        <div class="academic-year-filter mb-6">
            <form method="GET" action="{{ route('admin.fees.index') }}" class="flex items-center gap-4">
                <label for="academic_year" class="block text-sm font-medium text-gray-700 mb-0">Filter by Academic Year:</label>
                <select id="academic_year" name="academic_year" onchange="this.form.submit()" class="mt-1 block w-auto pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                    <option value="all" {{ empty($selected_year) || $selected_year == 'all' ? 'selected' : '' }}>All Academic Years</option>
                    @foreach($academic_years as $year)
                        <option value="{{ $year }}" {{ $selected_year == $year ? 'selected' : '' }}>
                            {{ $year }}
                        </option>
                    @endforeach
                </select>
            </form>
        </div>

        <!-- Statistics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Fees Due {{ !empty($selected_year) && $selected_year != 'all' ? "($selected_year)" : '' }}</h3>
                <div class="text-2xl font-bold text-indigo-600">${{ number_format($remaining_fees_due, 2) }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    From {{ $stats->total_records }} fee records
                    @if(!empty($selected_year) && $selected_year != 'all')
                        <div class="flex items-center mt-1">
                            <i class="fas fa-filter text-xs mr-1"></i> Filtered by: {{ $selected_year }}
                        </div>
                    @endif
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Fees Collected {{ !empty($selected_year) && $selected_year != 'all' ? "($selected_year)" : '' }}</h3>
                <div class="text-2xl font-bold text-green-600">${{ number_format($stats->total_fees_collected, 2) }}</div>
                <div class="text-sm text-gray-500 mt-2">
                    @if($stats->total_fees_due > 0)
                        {{ number_format(($stats->total_fees_collected / $stats->total_fees_due) * 100, 1) }}% collected
                    @else
                        No fees due
                    @endif
                </div>
            </div>
        </div>

        <!-- Status Breakdown -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center border-t-4 border-yellow-500">
                <span class="bg-yellow-500 inline-block w-3 h-3 rounded-full mb-2"></span>
                <span class="font-semibold text-gray-700">{{ $stats->pending_count }} Pending</span>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center border-t-4 border-blue-500">
                <span class="bg-blue-500 inline-block w-3 h-3 rounded-full mb-2"></span>
                <span class="font-semibold text-gray-700">{{ $stats->partial_count }} Partial</span>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center border-t-4 border-green-500">
                <span class="bg-green-500 inline-block w-3 h-3 rounded-full mb-2"></span>
                <span class="font-semibold text-gray-700">{{ $stats->paid_count }} Paid</span>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center border-t-4 border-red-500">
                <span class="bg-red-500 inline-block w-3 h-3 rounded-full mb-2"></span>
                <span class="font-semibold text-gray-700">{{ $stats->overdue_count }} Overdue</span>
            </div>
        </div>

        <!-- Payment Form -->
        <div class="bg-white rounded-lg shadow p-6 mb-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Record Payment</h3>
            <form action="{{ route('admin.fees.payment', 0) }}" method="POST" id="paymentForm">
                @csrf
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="fee_id" class="block text-sm font-medium text-gray-700 mb-1">Select Fee Record</label>
                        <select id="fee_id" name="fee_id" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                            <option value="">Select Fee Record</option>
                            @foreach($fees as $fee)
                                <option value="{{ $fee->fee_id }}">
                                    {{ $fee->student->name }} - {{ $fee->fee_type }} (${{ number_format($fee->amount, 2) }})
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paid_amount" class="block text-sm font-medium text-gray-700 mb-1">Amount Paid</label>
                        <input type="number" id="paid_amount" name="paid_amount" step="0.01" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                        <select id="payment_method" name="payment_method" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                            <option value="">Select Method</option>
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Mobile Money">Mobile Money</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reference_number" class="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
                        <input type="text" id="reference_number" name="reference_number" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg">
                        <i class="fas fa-money-bill-wave"></i>
                        Record Payment
                    </button>
                </div>
            </form>
        </div>

        <!-- Search and Filter Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input 
                            type="text" 
                            id="feeSearchInput" 
                            placeholder="Search fees by student, fee type, status, amount..." 
                            class="pl-10 pr-10 py-3 border-2 border-gray-200 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-300"
                        >
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <button id="clearSearch" class="text-gray-400 hover:text-gray-600 hidden transition-colors duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <select id="statusFilter" class="py-2 px-3 border-2 border-gray-200 rounded-lg bg-white text-sm min-w-[140px] transition-colors duration-300 focus:outline-none focus:border-blue-500">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="partial">Partial</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    
                    <select id="feeTypeFilter" class="py-2 px-3 border-2 border-gray-200 rounded-lg bg-white text-sm min-w-[140px] transition-colors duration-300 focus:outline-none focus:border-blue-500">
                        <option value="">All Fee Types</option>
                        <option value="Tuition Fee">Tuition Fee</option>
                        <option value="Registration Fee">Registration Fee</option>
                        <option value="Activity Fee">Activity Fee</option>
                        <option value="Technology Fee">Technology Fee</option>
                        <option value="Library Fee">Library Fee</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-4 flex flex-wrap items-center gap-4">
                <span class="text-sm text-gray-600" id="searchResultsCount">
                    Showing {{ count($fees) }} records
                </span>
                <button id="resetFilters" class="text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium">
                    <i class="fas fa-refresh mr-1"></i> Reset Filters
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="searchLoadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 shadow-2xl">
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-2"></i>
                        <div class="absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-20"></div>
                    </div>
                    <p class="mt-2 text-gray-600 font-medium">Searching fees...</p>
                    <p class="text-sm text-gray-400">Please wait while we find the best matches</p>
                </div>
            </div>
        </div>

        <!-- Fees Table -->
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Fee Records</h3>
        <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fee Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Installment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="feesTableBody">
                        @foreach($fees as $fee)
                        <tr class="hover:bg-gray-50 transition-colors duration-200 fee-row">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ $fee->student->name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ $fee->fee_type }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ $fee->installment_number }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${{ number_format($fee->amount, 2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ number_format($fee->paid_amount, 2) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ $fee->due_date->format('M j, Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @php
                                    $statusClasses = [
                                        'pending' => 'bg-yellow-100 text-yellow-800 border-yellow-200',
                                        'partial' => 'bg-blue-100 text-blue-800 border-blue-200',
                                        'paid' => 'bg-green-100 text-green-800 border-green-200',
                                        'overdue' => 'bg-red-100 text-red-800 border-red-200'
                                    ];
                                    $statusClass = $statusClasses[$fee->status] ?? 'bg-gray-100 text-gray-800 border-gray-200';
                                @endphp
                                <span class="px-3 py-1 rounded-full text-xs font-medium border {{ $statusClass }}">
                                    {{ ucfirst($fee->status) }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button onclick="viewFee({{ $fee->fee_id }})" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200 text-sm font-medium flex items-center gap-1 shadow-sm hover:shadow-md">
                                        <i class="fas fa-eye text-xs"></i> View
                                    </button>
                                    <button onclick="editFee({{ $fee->fee_id }})" class="bg-yellow-600 text-white px-3 py-2 rounded-lg hover:bg-yellow-700 transition-all duration-200 text-sm font-medium flex items-center gap-1 shadow-sm hover:shadow-md">
                                        <i class="fas fa-edit text-xs"></i> Edit
                                    </button>
                                    <button onclick="confirmDelete({{ $fee->fee_id }}, '{{ addslashes($fee->student->name . ' - ' . $fee->fee_type) }}')" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition-all duration-200 text-sm font-medium flex items-center gap-1 shadow-sm hover:shadow-md">
                                        <i class="fas fa-trash text-xs"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Assign Fee Modal -->
<div id="assignFeeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300">
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="assignFeeModalContent">
            <div class="bg-indigo-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Assign New Fee</h3>
                <button class="text-red-500 text-2xl hover:text-red-700 transition-colors" onclick="closeModal('assignFeeModal')">&times;</button>
            </div>
            <div class="p-6">
                <form action="{{ route('admin.fees.store') }}" method="POST" id="assignFeeForm">
                    @csrf
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="student_id" class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                            <select id="student_id" name="student_id" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                                <option value="">Select Student</option>
                                @foreach($students as $student)
                                    <option value="{{ $student->student_id }}">
                                        {{ $student->name }} ({{ $student->student_id }})
                                    </option>
                                @endforeach
                            </select>
                        </div>
                        <div>
                            <label for="fee_type" class="block text-sm font-medium text-gray-700 mb-1">Fee Type</label>
                            <select id="fee_type" name="fee_type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                                <option value="">Select Fee Type</option>
                                <option value="Tuition Fee">Tuition Fee</option>
                                <option value="Registration Fee">Registration Fee</option>
                                <option value="Activity Fee">Activity Fee</option>
                                <option value="Technology Fee">Technology Fee</option>
                                <option value="Library Fee">Library Fee</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="installment_number" class="block text-sm font-medium text-gray-700 mb-1">Installment Number</label>
                            <select id="installment_number" name="installment_number" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                                <option value="1">1st Installment</option>
                                <option value="2">2nd Installment</option>
                                <option value="3">3rd Installment</option>
                            </select>
                        </div>
                        <div>
                            <label for="academic_year" class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                            <input type="text" id="academic_year" name="academic_year" value="{{ date('Y') . '/' . (date('Y') + 1) }}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="amount" name="amount" step="0.01" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                        </div>
                        <div>
                            <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="due_date" name="due_date" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end space-x-3">
                        <button type="button" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold flex items-center gap-2" onclick="closeModal('assignFeeModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center gap-2">
                            <i class="fas fa-save"></i> Assign Fee
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteFeeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300">
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="deleteFeeModalContent">
            <div class="bg-red-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Confirm Delete</h3>
                <button class="text-red-500 text-2xl hover:text-red-700 transition-colors" onclick="closeModal('deleteFeeModal')">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-gray-700">Are you sure you want to delete the fee record for:</p>
                <p id="delete-fee-details" class="font-bold my-3 p-3 bg-gray-50 rounded border"></p>
                <p class="text-red-600 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i>This action cannot be undone.
                </p>
            </div>
            <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end space-x-3">
                <button type="button" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-all duration-200 font-semibold flex items-center gap-2" onclick="closeModal('deleteFeeModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <form id="deleteForm" method="POST">
                    @csrf
                    @method('DELETE')
                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold flex items-center gap-2">
                        <i class="fas fa-trash"></i> Delete Permanently
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Fee Modal -->
<div id="viewFeeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300">
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="viewFeeModalContent">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <div class="flex items-center">
                    <button onclick="enhancedPrintFeeDetails()" class="bg-white bg-opacity-20 p-2 rounded-lg mr-3 hover:bg-opacity-30 transition-all duration-200" title="Print Fee Details">
                        <i class="fas fa-print"></i>
                    </button>
                    <h3 class="text-xl font-semibold">Fee Details</h3>
                </div>
                <button class="text-red-500 text-2xl hover:text-red-700 transition-colors" onclick="closeModal('viewFeeModal')">&times;</button>
            </div>
            <div class="p-6">
                <!-- Printable content container -->
                <div id="printable-fee-details">
                    <div class="print-header hidden">
                        <h2 class="text-2xl font-bold text-center mb-4">Fee Details Receipt</h2>
                        <div class="border-b-2 border-gray-300 mb-4"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Student:</label>
                            <p class="detail-value text-gray-900" id="view-student">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Fee Type:</label>
                            <p class="detail-value text-gray-900" id="view-fee-type">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Installment:</label>
                            <p class="detail-value text-gray-900" id="view-installment">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Academic Year:</label>
                            <p class="detail-value text-gray-900" id="view-academic-year">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Amount:</label>
                            <p class="detail-value text-gray-900 font-semibold" id="view-amount">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Paid Amount:</label>
                            <p class="detail-value text-gray-900 font-semibold" id="view-paid-amount">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Due Date:</label>
                            <p class="detail-value text-gray-900" id="view-due-date">Loading...</p>
                        </div>
                        <div class="detail-group">
                            <label class="detail-label font-semibold text-gray-700">Status:</label>
                            <p class="detail-value" id="view-status">Loading...</p>
                        </div>
                    </div>

                    <!-- Payment History Section -->
                    <div class="payment-history mt-6">
                        <h4 class="text-lg font-semibold mb-3 text-gray-800">Payment History</h4>
                        <div id="payment-history-container">
                            <!-- Payment history will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end">
                <button type="button" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-all duration-200 font-semibold flex items-center gap-2" onclick="closeModal('viewFeeModal')">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Fee Modal -->
<div id="editFeeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden transition-opacity duration-300">
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="editFeeModalContent">
            <div class="bg-indigo-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-semibold">Edit Fee</h3>
                <button class="text-red-500 text-2xl hover:text-red-700 transition-colors" onclick="closeModal('editFeeModal')">&times;</button>
            </div>
            <div class="p-6">
                <form id="editFeeForm" method="POST">
                    @csrf
                    @method('PUT')
                    <input type="hidden" id="edit-fee-id" name="fee_id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label for="edit-fee-type" class="block text-sm font-medium text-gray-700 mb-1">Fee Type</label>
                            <select id="edit-fee-type" name="fee_type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                                <option value="">Select Fee Type</option>
                                <option value="Tuition Fee">Tuition Fee</option>
                                <option value="Registration Fee">Registration Fee</option>
                                <option value="Activity Fee">Activity Fee</option>
                                <option value="Technology Fee">Technology Fee</option>
                                <option value="Library Fee">Library Fee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-installment" class="block text-sm font-medium text-gray-700 mb-1">Installment</label>
                            <select id="edit-installment" name="installment_number" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                                <option value="1">1st Installment</option>
                                <option value="2">2nd Installment</option>
                                <option value="3">3rd Installment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                            <input type="number" id="edit-amount" name="amount" step="0.01" min="0" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-paid-amount" class="block text-sm font-medium text-gray-700 mb-1">Paid Amount ($)</label>
                            <input type="number" id="edit-paid-amount" name="paid_amount" step="0.01" min="0" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label for="edit-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="edit-due-date" name="due_date" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="edit-status" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg" required>
                                <option value="pending">Pending</option>
                                <option value="partial">Partial</option>
                                <option value="paid">Paid</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end space-x-3">
                        <button type="button" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-all duration-200 font-semibold flex items-center gap-2" onclick="closeModal('editFeeModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center gap-2">
                            <i class="fas fa-save"></i> Update Fee
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    
    const styles = {
        success: 'bg-gradient-to-r from-green-500 to-green-600 border-l-4 border-green-700',
        error: 'bg-gradient-to-r from-red-500 to-red-600 border-l-4 border-red-700',
        warning: 'bg-gradient-to-r from-yellow-500 to-yellow-600 border-l-4 border-yellow-700',
        info: 'bg-gradient-to-r from-blue-500 to-blue-600 border-l-4 border-blue-700'
    };

    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-triangle',
        warning: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };

    notification.className = `fixed top-4 right-4 z-50 transform translate-x-full opacity-0 transition-all duration-500 ease-in-out ${styles[type]} text-white p-4 rounded-xl shadow-2xl max-w-sm min-w-80 backdrop-blur-sm border-l-4`;
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas ${icons[type]} text-xl flex-shrink-0"></i>
            <span class="flex-1 text-sm font-medium">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="flex-shrink-0 p-1 rounded-lg hover:bg-white hover:bg-opacity-20 transition-colors duration-200">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
        notification.classList.add('translate-x-0', 'opacity-100');
    }, 10);

    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.remove('translate-x-0', 'opacity-100');
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 500);
        }
    }, 7000);
}

function showSuccessMessage(message) {
    showNotification(message, 'success');
}

function showErrorMessage(message) {
    showNotification(message, 'error');
}

function showWarningMessage(message) {
    showNotification(message, 'warning');
}

function showInfoMessage(message) {
    showNotification(message, 'info');
}

// REMOVED: Laravel flash message detection code
// This is what was causing double notifications

// Modal Functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    const modalContent = document.getElementById(modalId + 'Content');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    const modalContent = document.getElementById(modalId + 'Content');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }, 300);
}

function confirmDelete(feeId, feeDetails) {
    document.getElementById('delete-fee-details').textContent = feeDetails;
    document.getElementById('deleteForm').action = '/admin/fees/' + feeId;
    openModal('deleteFeeModal');
}

// ========== VIEW FEE FUNCTIONALITY ==========
async function viewFee(feeId) {
    console.log('Opening view modal for fee ID:', feeId);
    
    // Show loading state
    showInfoMessage('Loading fee details...');
    
    try {
        // Show loading states in modal
        setViewModalLoading(true);
        openModal('viewFeeModal');
        
        // Fetch real data from server
        const response = await fetch(`/admin/fees/${feeId}/details`);
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Server returned ${response.status} status`);
        }
        
        const feeData = await response.json();
        console.log('Fee data received:', feeData);
        
        // Update modal with real data
        updateViewModalWithData(feeData);
        
        // Show success message
        showSuccessMessage('Fee details loaded successfully!');
        
    } catch (error) {
        console.error('Error fetching fee details:', error);
        showErrorMessage('Failed to load fee details: ' + error.message);
        closeModal('viewFeeModal');
    }
}

// ========== EDIT FEE FUNCTIONALITY ==========
async function editFee(feeId) {
    console.log('Opening edit modal for fee ID:', feeId);
    
    // Show loading state
    showInfoMessage('Loading fee data for editing...');
    
    try {
        // Fetch real data from server
        const response = await fetch(`/admin/fees/${feeId}/edit`);
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Server returned ${response.status} status`);
        }
        
        const feeData = await response.json();
        console.log('Edit data received:', feeData);
        
        // Populate form with real data
        populateEditForm(feeData);
        openModal('editFeeModal');
        
        // Show success message
        showSuccessMessage('Fee data loaded successfully!');
        
    } catch (error) {
        console.error('Error fetching fee data for editing:', error);
        showErrorMessage('Failed to load fee data for editing: ' + error.message);
    }
}

// Helper functions
function setViewModalLoading(loading) {
    const elements = [
        'view-student', 'view-fee-type', 'view-installment', 
        'view-academic-year', 'view-amount', 'view-paid-amount', 
        'view-due-date', 'view-status'
    ];
    
    elements.forEach(id => {
        document.getElementById(id).textContent = loading ? 'Loading...' : '';
    });
}

function updateViewModalWithData(feeData) {
    document.getElementById('view-student').textContent = `${feeData.student.name} (ID: ${feeData.student.student_id})`;
    document.getElementById('view-fee-type').textContent = feeData.fee_type;
    document.getElementById('view-installment').textContent = `${feeData.installment_number}${getOrdinalSuffix(feeData.installment_number)} Installment`;
    document.getElementById('view-academic-year').textContent = feeData.academic_year;
    document.getElementById('view-amount').textContent = `$${parseFloat(feeData.amount).toFixed(2)}`;
    document.getElementById('view-paid-amount').textContent = `$${parseFloat(feeData.paid_amount).toFixed(2)}`;
    document.getElementById('view-due-date').textContent = new Date(feeData.due_date).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
    
    const statusClass = {
        'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'partial': 'bg-blue-100 text-blue-800 border-blue-200',
        'paid': 'bg-green-100 text-green-800 border-green-200',
        'overdue': 'bg-red-100 text-red-800 border-red-200'
    }[feeData.status] || 'bg-gray-100 text-gray-800 border-gray-200';
    
    document.getElementById('view-status').innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-medium border ${statusClass}">${feeData.status.charAt(0).toUpperCase() + feeData.status.slice(1)}</span>`;
}

function populateEditForm(feeData) {
    document.getElementById('edit-fee-id').value = feeData.fee_id;
    document.getElementById('edit-fee-type').value = feeData.fee_type;
    document.getElementById('edit-installment').value = feeData.installment_number;
    document.getElementById('edit-amount').value = feeData.amount;
    document.getElementById('edit-paid-amount').value = feeData.paid_amount;
    document.getElementById('edit-due-date').value = feeData.due_date;
    document.getElementById('edit-status').value = feeData.status;
    
    document.getElementById('editFeeForm').action = `/admin/fees/${feeData.fee_id}`;
}

function getOrdinalSuffix(number) {
    const suffixes = ['th', 'st', 'nd', 'rd'];
    const value = number % 100;
    return suffixes[(value - 20) % 10] || suffixes[value] || suffixes[0];
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('fixed') && event.target.id.includes('Modal')) {
        const modalId = event.target.id;
        closeModal(modalId);
    }
});

// Update payment form action dynamically
document.getElementById('fee_id').addEventListener('change', function() {
    const feeId = this.value;
    const form = document.getElementById('paymentForm');
    form.action = `/admin/fees/${feeId}/payment`;
});

// Search and Filter functionality with spinner
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('feeSearchInput');
    const statusFilter = document.getElementById('statusFilter');
    const feeTypeFilter = document.getElementById('feeTypeFilter');
    const clearSearchBtn = document.getElementById('clearSearch');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const searchResultsCount = document.getElementById('searchResultsCount');
    const feesTableBody = document.getElementById('feesTableBody');
    
    const tableRows = document.querySelectorAll('.fee-row');
    let searchTimeout;
    let activeFilters = {
        search: '',
        status: '',
        feeType: ''
    };
    
    // Initial count
    updateResultsCount(tableRows.length);
    
    function showLoadingSpinner() {
        const spinner = document.getElementById('searchLoadingSpinner');
        const rows = feesTableBody.querySelectorAll('.fee-row');
        
        if (rows) {
            rows.forEach(row => {
                row.style.opacity = '0.6';
            });
        }
        
        spinner.classList.remove('hidden');
    }

    function hideLoadingSpinner() {
        const spinner = document.getElementById('searchLoadingSpinner');
        const rows = feesTableBody.querySelectorAll('.fee-row');
        
        if (rows) {
            rows.forEach(row => {
                row.style.opacity = '1';
            });
        }
        
        spinner.classList.add('hidden');
    }
    
    // Search input event with debouncing and spinner
    searchInput.addEventListener('input', function(e) {
        activeFilters.search = e.target.value.toLowerCase();
        clearSearchBtn.classList.toggle('hidden', !e.target.value);
        
        showLoadingSpinner();
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
            filterTable();
            setTimeout(() => {
                hideLoadingSpinner();
            }, 300);
        }, 500);
    });
    
    // Status filter event
    statusFilter.addEventListener('change', function(e) {
        activeFilters.status = e.target.value;
        showLoadingSpinner();
        setTimeout(() => {
            filterTable();
            hideLoadingSpinner();
        }, 300);
    });
    
    // Fee type filter event
    feeTypeFilter.addEventListener('change', function(e) {
        activeFilters.feeType = e.target.value;
        showLoadingSpinner();
        setTimeout(() => {
            filterTable();
            hideLoadingSpinner();
        }, 300);
    });
    
    // Clear search button
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        activeFilters.search = '';
        clearSearchBtn.classList.add('hidden');
        showLoadingSpinner();
        setTimeout(() => {
            filterTable();
            hideLoadingSpinner();
        }, 300);
    });
    
    // Reset all filters
    resetFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        statusFilter.value = '';
        feeTypeFilter.value = '';
        activeFilters = {
            search: '',
            status: '',
            feeType: ''
        };
        clearSearchBtn.classList.add('hidden');
        showLoadingSpinner();
        setTimeout(() => {
            filterTable();
            hideLoadingSpinner();
        }, 300);
    });
    
    // Filter table function
    function filterTable() {
        let visibleCount = 0;
        
        tableRows.forEach(row => {
            const studentName = row.cells[0].textContent.toLowerCase();
            const feeType = row.cells[1].textContent.toLowerCase();
            const installment = row.cells[2].textContent.toLowerCase();
            const amount = row.cells[3].textContent.toLowerCase();
            const paidAmount = row.cells[4].textContent.toLowerCase();
            const dueDate = row.cells[5].textContent.toLowerCase();
            const status = row.cells[6].textContent.toLowerCase();
            
            // Check search term
            const matchesSearch = !activeFilters.search || 
                studentName.includes(activeFilters.search) ||
                feeType.includes(activeFilters.search) ||
                installment.includes(activeFilters.search) ||
                amount.includes(activeFilters.search) ||
                paidAmount.includes(activeFilters.search) ||
                dueDate.includes(activeFilters.search) ||
                status.includes(activeFilters.search);
            
            // Check status filter
            const matchesStatus = !activeFilters.status || 
                status.includes(activeFilters.status.toLowerCase());
            
            // Check fee type filter
            const matchesFeeType = !activeFilters.feeType || 
                feeType.includes(activeFilters.feeType.toLowerCase());
            
            // Show/hide row based on filters
            if (matchesSearch && matchesStatus && matchesFeeType) {
                row.classList.remove('hidden');
                visibleCount++;
            } else {
                row.classList.add('hidden');
            }
        });
        
        updateResultsCount(visibleCount);
    }
    
    function updateResultsCount(count) {
        searchResultsCount.textContent = `Showing ${count} record${count !== 1 ? 's' : ''}`;
        
        // Add highlight animation when count changes
        searchResultsCount.classList.add('text-blue-600', 'scale-105');
        setTimeout(() => {
            searchResultsCount.classList.remove('text-blue-600', 'scale-105');
        }, 500);
    }
    
    // Add keyboard shortcut for search (Ctrl/Cmd + F)
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
    });

    // Form submissions - ALLOW NORMAL FORM SUBMISSION
    const assignFeeForm = document.getElementById('assignFeeForm');
    if (assignFeeForm) {
        assignFeeForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Assigning...';
            submitButton.disabled = true;

            // Show custom notification immediately
            showSuccessMessage('Fee assigned successfully!');

            // Allow form to submit normally - no e.preventDefault()
            // Forms will submit to your Laravel backend as intended
            
            // Reset button after form submission (in case of validation errors)
            setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }, 5000);
        });
    }

    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
            submitButton.disabled = true;

            // Show custom notification immediately
            showSuccessMessage('Payment recorded successfully!');

            // Allow form to submit normally
            
            // Reset button after form submission (in case of validation errors)
            setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }, 5000);
        });
    }

    const editFeeForm = document.getElementById('editFeeForm');
    if (editFeeForm) {
        editFeeForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Updating...';
            submitButton.disabled = true;

            // Show custom notification immediately
            showSuccessMessage('Fee record updated successfully!');

            // Allow form to submit normally
            
            // Reset button after form submission (in case of validation errors)
            setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }, 5000);
        });
    }

    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Deleting...';
            submitButton.disabled = true;

            // Show custom notification immediately
            showSuccessMessage('Fee record deleted successfully!');

            // Allow form to submit normally
            
            // Reset button after form submission (in case of validation errors)
            setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }, 5000);
        });
    }
});

// Enhanced print function with school logo
function enhancedPrintFeeDetails() {
    const printableContent = document.getElementById('printable-fee-details').cloneNode(true);
    const printHeader = printableContent.querySelector('.print-header');
    
    if (printHeader) {
        printHeader.classList.remove('hidden');
    }
    
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Fee Details Receipt - ${document.querySelector('.school-name')?.textContent || 'EDMOL Baptist'}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 25px; color: #000; }
                .header { text-align: center; margin-bottom: 25px; }
                .school-info { margin-bottom: 15px; }
                .school-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                .receipt-title { font-size: 20px; margin: 15px 0; color: #2c5282; }
                .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
                .detail-group { margin-bottom: 12px; page-break-inside: avoid; }
                .detail-label { font-weight: bold; color: #000; }
                .detail-value { color: #000; }
                .payment-history { margin-top: 25px; border-top: 1px solid #ccc; padding-top: 15px; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
                @media print { body { margin: 15mm; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="school-info">
                    <div class="school-name">${document.querySelector('.school-name')?.textContent || 'EDMOL Baptist'}</div>
                    <div>Fee Details Receipt</div>
                </div>
                <div style="border-bottom: 2px solid #333; margin: 15px 0;"></div>
            </div>
            ${printableContent.innerHTML}
            <div class="footer">
                Printed on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    printWindow.onload = function() {
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
        }, 250);
    };
}
</script>
@endsection

















































<script>
// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    
    const styles = {
        success: 'bg-gradient-to-r from-green-500 to-green-600 border-l-4 border-green-700',
        error: 'bg-gradient-to-r from-red-500 to-red-600 border-l-4 border-red-700',
        warning: 'bg-gradient-to-r from-yellow-500 to-yellow-600 border-l-4 border-yellow-700',
        info: 'bg-gradient-to-r from-blue-500 to-blue-600 border-l-4 border-blue-700'
    };

    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-triangle',
        warning: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };

    notification.className = `fixed top-4 right-4 z-50 transform translate-x-full opacity-0 transition-all duration-500 ease-in-out ${styles[type]} text-white p-4 rounded-xl shadow-2xl max-w-sm min-w-80 backdrop-blur-sm border-l-4`;
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas ${icons[type]} text-xl flex-shrink-0"></i>
            <span class="flex-1 text-sm font-medium">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="flex-shrink-0 p-1 rounded-lg hover:bg-white hover:bg-opacity-20 transition-colors duration-200">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
        notification.classList.add('translate-x-0', 'opacity-100');
    }, 10);

    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.remove('translate-x-0', 'opacity-100');
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 500);
        }
    }, 7000);
}

function showSuccessMessage(message) {
    showNotification(message, 'success');
}

function showErrorMessage(message) {
    showNotification(message, 'error');
}

function showWarningMessage(message) {
    showNotification(message, 'warning');
}

function showInfoMessage(message) {
    showNotification(message, 'info');
}

// ========== MODAL FUNCTIONS ==========
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    const modalContent = document.getElementById(modalId + 'Content');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    const modalContent = document.getElementById(modalId + 'Content');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }, 300);
}

// ========== EDIT SUBJECTS MODAL ==========
function openEditModal(gradeId, subjects) {
    const modal = document.getElementById('editSubjectsModal');
    const form = document.getElementById('editSubjectsForm');
    const container = document.getElementById('subjectsContainer');
    
    form.action = `/admin/grades/${gradeId}/subjects`;
    container.innerHTML = '';
    
    try {
        let parsedSubjects = typeof subjects === 'string' ? JSON.parse(subjects) : subjects;
        
        if (Array.isArray(parsedSubjects) && parsedSubjects.length > 0) {
            parsedSubjects.forEach(subject => {
                addSubjectField(subject);
            });
        } else {
            addSubjectField();
        }
        
        openModal('editSubjectsModal');
    } catch (error) {
        console.error('Error parsing subjects:', error);
        addSubjectField();
        openModal('editSubjectsModal');
    }
}

function closeEditModal() {
    closeModal('editSubjectsModal');
}

function addSubjectField(value = '') {
    const container = document.getElementById('subjectsContainer');
    const div = document.createElement('div');
    div.className = 'flex items-center gap-2 p-2 bg-white rounded border border-gray-200';
    div.innerHTML = `
        <input type="text" name="subjects[]" value="${value}" 
               class="flex-grow rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
               placeholder="Enter subject name" required>
        <button type="button" onclick="this.parentElement.remove()" 
                class="p-2 text-red-600 hover:text-red-700 bg-red-50 hover:bg-red-100 rounded-lg transition-all duration-200">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(div);
}










// ========== UNASSIGN CONFIRMATION MODAL ==========
function confirmUnassignTeacher(button) {
    console.log('=== confirmUnassignTeacher START ===');
    try {
        const form = button.closest('form');
        console.log('1. Button clicked:', button);
        console.log('2. Form found:', form);
        
        if (!form) {
            console.error('Form not found for teacher unassign');
            return;
        }
        
        let teacherName = 'this teacher';
        
        // Look for the teacher name in the parent container
        const teacherCard = button.closest('.bg-blue-50');
        console.log('3. Teacher card found:', teacherCard);
        
        if (teacherCard) {
            const nameElement = teacherCard.querySelector('.font-medium');
            console.log('4. Name element found:', nameElement);
            if (nameElement && nameElement.textContent) {
                teacherName = nameElement.textContent.trim();
                console.log('5. Teacher name extracted:', teacherName);
            }
        }
        
        console.log('6. Setting message for:', teacherName);
        document.getElementById('unassignMessage').textContent = `Are you sure you want to remove ${teacherName} from this grade?`;
        document.getElementById('unassignForm').action = form.action;
        console.log('7. Form action set to:', form.action);
        
        // FIX: Create proper form content instead of cloning the wrong button
        const formContent = `
            <input type="hidden" name="_token" value="${form.querySelector('input[name="_token"]').value}">
            ${form.querySelector('input[name="_method"]') ? '<input type="hidden" name="_method" value="DELETE">' : ''}
            <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold flex items-center gap-2">
                <i class="fas fa-user-minus"></i>
                Confirm Unassign
            </button>
        `;
        
        console.log('8. Form content created:', formContent);
        document.getElementById('unassignForm').innerHTML = formContent;
        
        // Debug the modal form after injection
        const modalForm = document.getElementById('unassignForm');
        console.log('9. Modal form after injection:', modalForm);
        console.log('10. Modal form innerHTML:', modalForm.innerHTML);
        
        openModal('unassignConfirmModal');
        console.log('11. Modal opened successfully');
        
    } catch (error) {
        console.error('Error in confirmUnassignTeacher:', error);
        showErrorMessage('Failed to open confirmation dialog');
    }
    console.log('=== confirmUnassignTeacher END ===');
}

function confirmUnassignStudent(button) {
    console.log('=== confirmUnassignStudent START ===');
    try {
        const form = button.closest('form');
        console.log('1. Button clicked:', button);
        console.log('2. Form found:', form);
        
        if (!form) {
            console.error('Form not found for student unassign');
            return;
        }
        
        let studentName = 'this student';
        
        // Look for the student name in the parent container
        const studentCard = button.closest('.bg-green-50');
        console.log('3. Student card found:', studentCard);
        
        if (studentCard) {
            const nameElement = studentCard.querySelector('.font-medium');
            console.log('4. Name element found:', nameElement);
            if (nameElement && nameElement.textContent) {
                studentName = nameElement.textContent.trim();
                console.log('5. Student name extracted:', studentName);
            }
        }
        
        console.log('6. Setting message for:', studentName);
        document.getElementById('unassignMessage').textContent = `Are you sure you want to unassign ${studentName} from this grade?`;
        document.getElementById('unassignForm').action = form.action;
        console.log('7. Form action set to:', form.action);
        
        // FIX: Create proper form content instead of cloning the wrong button
        const formContent = `
            <input type="hidden" name="_token" value="${form.querySelector('input[name="_token"]').value}">
            ${form.querySelector('input[name="_method"]') ? '<input type="hidden" name="_method" value="DELETE">' : ''}
            <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold flex items-center gap-2">
                <i class="fas fa-user-minus"></i>
                Confirm Unassign
            </button>
        `;
        
        console.log('8. Form content created:', formContent);
        document.getElementById('unassignForm').innerHTML = formContent;
        
        // Debug the modal form after injection
        const modalForm = document.getElementById('unassignForm');
        console.log('9. Modal form after injection:', modalForm);
        console.log('10. Modal form innerHTML:', modalForm.innerHTML);
        
        openModal('unassignConfirmModal');
        console.log('11. Modal opened successfully');
        
    } catch (error) {
        console.error('Error in confirmUnassignStudent:', error);
        showErrorMessage('Failed to open confirmation dialog');
    }
    console.log('=== confirmUnassignStudent END ===');
}

function closeUnassignModal() {
    closeModal('unassignConfirmModal');
}


// ========== FORM SUBMISSIONS ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded - Setting up form listeners ===');
    
    // ... keep your existing Assign Teacher, Assign Student, Edit Subjects forms ...
    // Assign Teacher Form
    const assignTeacherForm = document.getElementById('assignTeacherForm');
    if (assignTeacherForm) {
        assignTeacherForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Assigning...';
            submitButton.disabled = true;

            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_token"]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    return { success: true };
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: true };
                    }
                });
            })
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Teacher assigned successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to assign teacher');
                }
            })
            .catch(error => {
                console.error('Assign teacher error:', error);
                showErrorMessage('Failed to assign teacher: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }

    // Assign Student Form
    const assignStudentForm = document.getElementById('assignStudentForm');
    if (assignStudentForm) {
        assignStudentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Assigning...';
            submitButton.disabled = true;

            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_token"]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    return { success: true };
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: true };
                    }
                });
            })
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Student assigned successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to assign student');
                }
            })
            .catch(error => {
                console.error('Assign student error:', error);
                showErrorMessage('Failed to assign student: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }

    // Edit Subjects Form
    const editSubjectsForm = document.getElementById('editSubjectsForm');
    if (editSubjectsForm) {
        editSubjectsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
            submitButton.disabled = true;

            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_token"]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    return { success: true };
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: true };
                    }
                });
            })
            .then(data => {
                if (data.success) {
                    closeEditModal();
                    showSuccessMessage('Subjects updated successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to update subjects');
                }
            })
            .catch(error => {
                console.error('Edit subjects error:', error);
                showErrorMessage('Failed to update subjects: ' + error.message);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }

    // Unassign Form Event Listener - WITH DEBUG
const unassignForm = document.getElementById('unassignForm');
console.log('Unassign form on page load:', unassignForm);

if (unassignForm) {
    console.log('Setting up unassign form event listener');
    
    unassignForm.addEventListener('submit', function(e) {
        console.log('=== UNASSIGN FORM SUBMIT EVENT FIRED ===');
        console.log('1. Submit event triggered');
        
        e.preventDefault();
        console.log('2. Default prevented');
        
        const submitButton = this.querySelector('button[type="submit"]');
        console.log('3. Submit button found:', submitButton);
        
        if (!submitButton) {
            console.error('No submit button found in form!');
            return;
        }
        
        const originalText = submitButton.innerHTML;
        console.log('4. Original button text:', originalText);
        
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        submitButton.disabled = true;
        console.log('5. Button state updated to loading');

        const formData = new FormData(this);
        console.log('6. FormData created');
        
        const method = formData.get('_method') || 'POST';
        const actualMethod = method === 'DELETE' ? 'DELETE' : 'POST';
        console.log('7. Method detected:', method, '-> Actual method:', actualMethod);
        
        const finalFormData = new FormData();
        finalFormData.append('_token', formData.get('_token'));
        console.log('8. Final FormData prepared with token:', formData.get('_token'));

        console.log('9. Making fetch request to:', this.action);
        console.log('10. Request details:', {
            method: actualMethod,
            action: this.action,
            hasToken: !!formData.get('_token')
        });

        fetch(this.action, {
            method: actualMethod,
            body: finalFormData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': document.querySelector('input[name="_token"]').value
            }
        })
        .then(response => {
            console.log('11. Fetch response received:', response);
            console.log('12. Response status:', response.status);
            console.log('13. Response redirected:', response.redirected);
            console.log('14. Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.redirected) {
                console.log('15. Response is redirected, returning success');
                return { success: true };
            }
            
            return response.text().then(text => {
                console.log('16. Response text:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('17. JSON parsed successfully:', jsonData);
                    return jsonData;
                } catch (e) {
                    console.log('18. JSON parse failed, returning success');
                    return { success: true };
                }
            });
        })
        .then(data => {
            console.log('19. Final data received:', data);
            if (data.success) {
                console.log('20. Success - closing modal and showing message');
                // FIX: Use closeModal directly instead of closeUnassignModal
                closeModal('unassignConfirmModal');
                showSuccessMessage('Unassigned successfully!');
                setTimeout(() => {
                    console.log('21. Reloading page...');
                    window.location.reload();
                }, 1500);
            } else {
                console.log('20. Error - throwing error');
                throw new Error(data.message || 'Failed to unassign');
            }
        })
        .catch(error => {
            console.error('22. Catch block - Error:', error);
            console.error('23. Error message:', error.message);
            showErrorMessage('Failed to unassign: ' + error.message);
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
            console.log('24. Button state reset');
        });
    });
    
    console.log('Unassign form event listener setup complete');
} else {
    console.error('Unassign form not found on page load!');
}

});





</script>
@endsection